---
title: "structure-function separation"
author: "SunXinRu"
date: "2025-07-19"
output: html_document
---
# lasso
```{r}
# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
library(glmnet)
library(dplyr)
library(ggplot2)

# ğŸ“Œ è®¾ç½®å‚æ•°
set.seed(123)
n_repeat <- 100
n_sample <- 7
X_all <- data_remained
X_explicit <- X_all[, 1:133]
X_implicit <- X_all[, 134:140]

# ğŸ“Œ åˆå§‹åŒ–æ€»ç»“æœè¡¨
results_all <- data.frame()

# ğŸ“Œ éå† health_var ä¸­çš„æ‰€æœ‰é¢„æµ‹å˜é‡ï¼ˆé™¤ç¬¬1åˆ— IDï¼‰
for (varname in colnames(health_var)[-1]) {
  
  y <- health_var[[varname]]  # å½“å‰ç›®æ ‡å˜é‡
  
  results <- data.frame(iteration = 1:n_repeat,
                        outcome = varname,
                        RMSE_exp = NA,
                        RMSE_imp = NA,
                        R2_exp = NA,
                        R2_imp = NA)
  
  for (i in 1:n_repeat) {
    # â€”â€” Step 1: æ˜¾æ€§æŠ½æ ·
    sampled_cols <- sample(colnames(X_explicit), n_sample)
    X_sampled <- X_explicit[, sampled_cols]
    
    # â€”â€” Step 2: å»ºæ¨¡ä¸é¢„æµ‹
    model_exp <- cv.glmnet(as.matrix(X_sampled), y, alpha = 1, standardize = FALSE)
    model_imp <- cv.glmnet(as.matrix(X_implicit), y, alpha = 1, standardize = FALSE)
    
    rmse_exp <- min(model_exp$cvm)
    rmse_imp <- min(model_imp$cvm)
    
    r2_exp <- 1 - rmse_exp^2 / var(y)
    r2_imp <- 1 - rmse_imp^2 / var(y)
    
    # â€”â€” Step 3: å­˜å‚¨ç»“æœ
    results$RMSE_exp[i] <- rmse_exp
    results$RMSE_imp[i] <- rmse_imp
    results$R2_exp[i] <- r2_exp
    results$R2_imp[i] <- r2_imp
  }
  
  # â€”â€” åˆå¹¶è¿›æ€»è¡¨
  results_all <- rbind(results_all, results)
}

# âœ… æŸ¥çœ‹æ•´ä½“ç»“æœï¼ˆæŒ‰å˜é‡åˆ†ç»„å¹³å‡ï¼‰
summary_df <- results_all %>%
  group_by(outcome) %>%
  summarise(
    mean_RMSE_exp = mean(RMSE_exp),
    mean_RMSE_imp = mean(RMSE_imp),
    mean_R2_exp = mean(R2_exp),
    mean_R2_imp = mean(R2_imp)
  )

print(summary_df)

# âœ… å¯è§†åŒ–ï¼šæ¯ä¸ªå¿ƒç†å˜é‡åˆ†åˆ«ç”»å‡º RÂ² å¯¹æ¯”
library(tidyr)

results_long <- results_all %>%
  select(outcome, iteration, R2_exp, R2_imp) %>%
  pivot_longer(cols = c(R2_exp, R2_imp), names_to = "type", values_to = "R2")

ggplot(results_long, aes(x = type, y = R2, fill = type)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.8) +
  facet_wrap(~ outcome, scales = "free_y") +
  labs(title = "æ˜¾æ€§ vs éšæ€§é¢„æµ‹æ•ˆæœå¯¹æ¯”ï¼ˆæŒ‰å¿ƒç†å˜é‡ï¼‰",
       x = "", y = expression(R^2)) +
  theme_minimal()
```

# éšæœºæ£®æ—
```{r}
# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
library(randomForest)
library(dplyr)
library(ggplot2)
library(tidyr)

# ğŸ“Œ è®¾ç½®å‚æ•°
set.seed(123)
n_repeat <- 100
n_sample <- 7
X_all <- data_remained
X_explicit <- X_all[, 1:133]
X_implicit <- X_all[, 134:140]

# ğŸ“Œ åˆå§‹åŒ–æ€»ç»“æœè¡¨
results_all_rf <- data.frame()

# ğŸ“Œ éå† health_var ä¸­çš„æ‰€æœ‰é¢„æµ‹å˜é‡ï¼ˆé™¤ç¬¬1åˆ— IDï¼‰
for (varname in colnames(health_var)[-1]) {
  
  y <- health_var[[varname]]  # å½“å‰ç›®æ ‡å˜é‡
  
  results <- data.frame(iteration = 1:n_repeat,
                        outcome = varname,
                        RMSE_exp = NA,
                        RMSE_imp = NA,
                        R2_exp = NA,
                        R2_imp = NA)
  
  for (i in 1:n_repeat) {
    # â€”â€” Step 1: æ˜¾æ€§æŠ½æ ·
    sampled_cols <- sample(colnames(X_explicit), n_sample)
    X_sampled <- X_explicit[, sampled_cols]
    
    # â€”â€” Step 2: æ˜¾æ€§éšæœºæ£®æ—å»ºæ¨¡ï¼ˆæŠ½æ ·7é¡¹ï¼‰
    rf_exp <- randomForest(x = X_sampled, y = y, ntree = 500)
    pred_exp <- predict(rf_exp, newdata = X_sampled)
    rmse_exp <- sqrt(mean((pred_exp - y)^2))
    r2_exp <- 1 - sum((pred_exp - y)^2) / sum((y - mean(y))^2)
    
    # â€”â€” Step 3: éšæ€§éšæœºæ£®æ—å»ºæ¨¡ï¼ˆ7é¡¹å…¨é‡ï¼‰
    rf_imp <- randomForest(x = X_implicit, y = y, ntree = 500)
    pred_imp <- predict(rf_imp, newdata = X_implicit)
    rmse_imp <- sqrt(mean((pred_imp - y)^2))
    r2_imp <- 1 - sum((pred_imp - y)^2) / sum((y - mean(y))^2)
    
    # â€”â€” Step 4: å­˜å‚¨ç»“æœ
    results$RMSE_exp[i] <- rmse_exp
    results$RMSE_imp[i] <- rmse_imp
    results$R2_exp[i] <- r2_exp
    results$R2_imp[i] <- r2_imp
  }
  
  # â€”â€” åˆå¹¶è¿›æ€»è¡¨
  results_all_rf <- rbind(results_all_rf, results)
}

# âœ… æ±‡æ€»å¹³å‡ç»“æœ
summary_rf <- results_all_rf %>%
  group_by(outcome) %>%
  summarise(
    mean_RMSE_exp = mean(RMSE_exp),
    mean_RMSE_imp = mean(RMSE_imp),
    mean_R2_exp = mean(R2_exp),
    mean_R2_imp = mean(R2_imp)
  )

print(summary_rf)

results_long_rf <- results_all_rf %>%
  pivot_longer(cols = c(R2_exp, R2_imp), names_to = "type", values_to = "R2")

ggplot(results_long_rf, aes(x = type, y = R2, fill = type)) +
  geom_boxplot(alpha = 0.6, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1.2, color = "black") +
  facet_wrap(~ outcome, scales = "free_x") +
  scale_y_continuous(limits = c(0.2, 1)) +
  labs(title = "éšæœºæ£®æ—é¢„æµ‹ä¸‹æ˜¾æ€§ vs éšæ€§æµ‹é‡é¢„æµ‹åŠ›",
       x = "", y = expression(R^2)) +
  theme_minimal()
```
# æ³›åŒ–æ‹Ÿåˆ
```{r}
library(randomForest)
library(dplyr)
library(ggplot2)
library(tidyr)

set.seed(123)
n_repeat <- 100
n_sample <- 7
test_ratio <- 0.2

X_all <- data_remained
X_explicit <- X_all[, 1:133]
X_implicit <- X_all[, 134:140]

results_all_rf <- data.frame()

for (varname in colnames(health_var)[-1]) {
  
  y <- health_var[[varname]]
  
  results <- data.frame(iteration = 1:n_repeat,
                        outcome = varname,
                        RMSE_exp = NA,
                        RMSE_imp = NA,
                        R2_exp = NA,
                        R2_imp = NA)
  
  for (i in 1:n_repeat) {
    # --- åˆ’åˆ†è®­ç»ƒé›† & æµ‹è¯•é›†
    test_idx <- sample(seq_len(nrow(X_all)), size = floor(test_ratio * nrow(X_all)))
    train_idx <- setdiff(seq_len(nrow(X_all)), test_idx)
    
    # --- æ˜¾æ€§æ•°æ®éšæœºé€‰ç‰¹å¾ï¼ˆåªåœ¨è®­ç»ƒé›†ï¼‰
    sampled_cols <- sample(colnames(X_explicit), n_sample)
    
    X_train_exp <- X_explicit[train_idx, sampled_cols, drop = FALSE]
    X_test_exp  <- X_explicit[test_idx, sampled_cols, drop = FALSE]
    
    X_train_imp <- X_implicit[train_idx, , drop = FALSE]
    X_test_imp  <- X_implicit[test_idx, , drop = FALSE]
    
    y_train <- y[train_idx]
    y_test  <- y[test_idx]
    
    # --- æ˜¾æ€§æ¨¡å‹
    rf_exp <- randomForest(x = X_train_exp, y = y_train, ntree = 1000, mtry = floor(n_sample/3))
    pred_exp <- predict(rf_exp, newdata = X_test_exp)
    rmse_exp <- sqrt(mean((pred_exp - y_test)^2))
    r2_exp <- 1 - sum((pred_exp - y_test)^2) / sum((y_test - mean(y_test))^2)
    
    # --- éšæ€§æ¨¡å‹
    rf_imp <- randomForest(x = X_train_imp, y = y_train, ntree = 1000, mtry = floor(ncol(X_implicit)/3))
    pred_imp <- predict(rf_imp, newdata = X_test_imp)
    rmse_imp <- sqrt(mean((pred_imp - y_test)^2))
    r2_imp <- 1 - sum((pred_imp - y_test)^2) / sum((y_test - mean(y_test))^2)
    
    # --- å­˜ç»“æœ
    results$RMSE_exp[i] <- rmse_exp
    results$RMSE_imp[i] <- rmse_imp
    results$R2_exp[i] <- r2_exp
    results$R2_imp[i] <- r2_imp
  }
  
  results_all_rf <- rbind(results_all_rf, results)
}

# --- æ±‡æ€»
summary_rf <- results_all_rf %>%
  group_by(outcome) %>%
  summarise(
    mean_RMSE_exp = mean(RMSE_exp),
    mean_RMSE_imp = mean(RMSE_imp),
    mean_R2_exp = mean(R2_exp),
    mean_R2_imp = mean(R2_imp)
  )

print(summary_rf)
```




# æ ¹æ®EGAç»“æœåˆ©ç”¨åæŠ˜äº¤å‰éªŒè¯è¿›è¡Œé¢„æµ‹
# çº¿æ€§
```{r}
# æ ¹æ®EGAçš„ç­›é€‰åˆ›å»ºåªåŒ…å«ä¿ç•™æ¡ç›®çš„æ•°æ®æ¡†
kept_data <- data_z[, kept_items]

# åŠ è½½å¿…è¦çš„åŒ…
library(caret)

#-------------------------
# 1. åˆ†ç¦»é—®å·æ•°æ®å’Œè¡Œä¸ºæ•°æ®
#-------------------------
questionnaire_data <- kept_data[, 1:132]   # é—®å·
behavior_data      <- kept_data[, 133:142] # è¡Œä¸ºä»»åŠ¡

#-------------------------
# 2. å¤„ç†å¾…é¢„æµ‹å˜é‡
#-------------------------
# å»æ‰ç¬¬ä¸€åˆ—è¢«è¯•ç¼–å·
targets <- health_var[, -1]

# æ£€æŸ¥å˜é‡å
colnames(targets)

#-------------------------
# 3. å®šä¹‰åæŠ˜äº¤å‰éªŒè¯æ§åˆ¶
#-------------------------
set.seed(123) # ä¿è¯ç»“æœå¯å¤ç°
cv_control <- trainControl(
  method = "cv",
  number = 10,
  verboseIter = TRUE
)

#-------------------------
# 4. å®šä¹‰é¢„æµ‹å‡½æ•°
#-------------------------
run_cv <- function(predictors, outcome_name) {
  
  # outcome_name æ˜¯å› å˜é‡çš„åå­—
  outcome <- targets[[outcome_name]]
  
  # åˆå¹¶é¢„æµ‹å˜é‡å’Œå› å˜é‡
  df <- data.frame(outcome = outcome, predictors)
  
  # æ¨¡å‹ï¼šçº¿æ€§å›å½’ï¼ˆå¯ä»¥æ”¹æˆ 'glmnet', 'rf', 'xgbTree' ç­‰ï¼‰
  model <- train(
    outcome ~ .,
    data = df,
    method = "glmnet",  # LASSO / Ridge / Elastic Net
    trControl = cv_control,
    preProcess = c("center", "scale"),
    tuneLength = 10
  )
  
  return(model)
}

#-------------------------
# 5. å¾ªç¯è·‘å››ä¸ªå¥åº·å˜é‡
#-------------------------
# ç”¨é—®å·æ•°æ®
results_questionnaire <- lapply(colnames(targets), function(var) {
  cat("é—®å·æ•°æ®é¢„æµ‹ï¼š", var, "\n")
  run_cv(questionnaire_data, var)
})

# ç”¨è¡Œä¸ºæ•°æ®
results_behavior <- lapply(colnames(targets), function(var) {
  cat("è¡Œä¸ºæ•°æ®é¢„æµ‹ï¼š", var, "\n")
  run_cv(behavior_data, var)
})

#-------------------------
# 6. æŸ¥çœ‹é¢„æµ‹æ•ˆæœï¼ˆRMSE, RÂ² ç­‰ï¼‰
#-------------------------
get_performance <- function(model_list) {
  sapply(model_list, function(m) {
    c(RMSE = min(m$results$RMSE),
      Rsq  = max(m$results$Rsquared))
  })
}

perf_questionnaire <- get_performance(results_questionnaire)
perf_behavior <- get_performance(results_behavior)

perf_questionnaire
perf_behavior
```


# éçº¿æ€§ï¼ˆéšæœºæ£®æ—ï¼‰
```{r}
library(caret)
library(randomForest)

set.seed(123)

# 1. åˆ†å¼€é—®å·å’Œè¡Œä¸ºæ•°æ®
data_questionnaire <- kept_data[, 1:132]
data_behavior <- kept_data[, 133:142]

# 2. å¾…é¢„æµ‹å˜é‡ï¼ˆå»æ‰ç¬¬ä¸€åˆ— IDï¼‰
target_vars <- health_var[, -1]  

# åˆ›å»ºå­˜å‚¨ç»“æœçš„çŸ©é˜µ
perf_questionnaire_rf <- matrix(NA, nrow = 2, ncol = ncol(target_vars))
rownames(perf_questionnaire_rf) <- c("RMSE", "Rsq")
colnames(perf_questionnaire_rf) <- colnames(target_vars)

perf_behavior_rf <- matrix(NA, nrow = 2, ncol = ncol(target_vars))
rownames(perf_behavior_rf) <- c("RMSE", "Rsq")
colnames(perf_behavior_rf) <- colnames(target_vars)

# 3. åæŠ˜äº¤å‰éªŒè¯æ§åˆ¶
train_control <- trainControl(method = "cv", number = 10)

# 4. å¾ªç¯é¢„æµ‹å››ä¸ªå˜é‡
for (i in seq_along(target_vars)) {
  y <- target_vars[[i]]
  
  # é—®å·æ•°æ®
  df_q <- data.frame(y = y, data_questionnaire)
  model_q <- train(y ~ ., data = df_q, method = "rf",
                   trControl = train_control,
                   tuneLength = 5,
                   importance = TRUE)
  perf_questionnaire_rf[1, i] <- min(model_q$results$RMSE)
  perf_questionnaire_rf[2, i] <- max(model_q$results$Rsquared)
  
  # è¡Œä¸ºæ•°æ®
  df_b <- data.frame(y = y, data_behavior)
  model_b <- train(y ~ ., data = df_b, method = "rf",
                   trControl = train_control,
                   tuneLength = 5,
                   importance = TRUE)
  perf_behavior_rf[1, i] <- min(model_b$results$RMSE)
  perf_behavior_rf[2, i] <- max(model_b$results$Rsquared)
}

# 5. è¾“å‡ºç»“æœ
perf_questionnaire_rf
perf_behavior_rf
```


