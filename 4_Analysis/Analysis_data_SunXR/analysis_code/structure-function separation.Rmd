---
title: "structure-function separation"
author: "SunXinRu"
date: "2025-07-19"
output: html_document
---
# lasso
```{r}
# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
library(glmnet)
library(dplyr)
library(ggplot2)

# ğŸ“Œ è®¾ç½®å‚æ•°
set.seed(123)
n_repeat <- 100
n_sample <- 7
X_all <- data_remained
X_explicit <- X_all[, 1:133]
X_implicit <- X_all[, 134:140]

# ğŸ“Œ åˆå§‹åŒ–æ€»ç»“æœè¡¨
results_all <- data.frame()

# ğŸ“Œ éå† health_var ä¸­çš„æ‰€æœ‰é¢„æµ‹å˜é‡ï¼ˆé™¤ç¬¬1åˆ— IDï¼‰
for (varname in colnames(health_var)[-1]) {
  
  y <- health_var[[varname]]  # å½“å‰ç›®æ ‡å˜é‡
  
  results <- data.frame(iteration = 1:n_repeat,
                        outcome = varname,
                        RMSE_exp = NA,
                        RMSE_imp = NA,
                        R2_exp = NA,
                        R2_imp = NA)
  
  for (i in 1:n_repeat) {
    # â€”â€” Step 1: æ˜¾æ€§æŠ½æ ·
    sampled_cols <- sample(colnames(X_explicit), n_sample)
    X_sampled <- X_explicit[, sampled_cols]
    
    # â€”â€” Step 2: å»ºæ¨¡ä¸é¢„æµ‹
    model_exp <- cv.glmnet(as.matrix(X_sampled), y, alpha = 1, standardize = FALSE)
    model_imp <- cv.glmnet(as.matrix(X_implicit), y, alpha = 1, standardize = FALSE)
    
    rmse_exp <- min(model_exp$cvm)
    rmse_imp <- min(model_imp$cvm)
    
    r2_exp <- 1 - rmse_exp^2 / var(y)
    r2_imp <- 1 - rmse_imp^2 / var(y)
    
    # â€”â€” Step 3: å­˜å‚¨ç»“æœ
    results$RMSE_exp[i] <- rmse_exp
    results$RMSE_imp[i] <- rmse_imp
    results$R2_exp[i] <- r2_exp
    results$R2_imp[i] <- r2_imp
  }
  
  # â€”â€” åˆå¹¶è¿›æ€»è¡¨
  results_all <- rbind(results_all, results)
}

# âœ… æŸ¥çœ‹æ•´ä½“ç»“æœï¼ˆæŒ‰å˜é‡åˆ†ç»„å¹³å‡ï¼‰
summary_df <- results_all %>%
  group_by(outcome) %>%
  summarise(
    mean_RMSE_exp = mean(RMSE_exp),
    mean_RMSE_imp = mean(RMSE_imp),
    mean_R2_exp = mean(R2_exp),
    mean_R2_imp = mean(R2_imp)
  )

print(summary_df)

# âœ… å¯è§†åŒ–ï¼šæ¯ä¸ªå¿ƒç†å˜é‡åˆ†åˆ«ç”»å‡º RÂ² å¯¹æ¯”
library(tidyr)

results_long <- results_all %>%
  select(outcome, iteration, R2_exp, R2_imp) %>%
  pivot_longer(cols = c(R2_exp, R2_imp), names_to = "type", values_to = "R2")

ggplot(results_long, aes(x = type, y = R2, fill = type)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.8) +
  facet_wrap(~ outcome, scales = "free_y") +
  labs(title = "æ˜¾æ€§ vs éšæ€§é¢„æµ‹æ•ˆæœå¯¹æ¯”ï¼ˆæŒ‰å¿ƒç†å˜é‡ï¼‰",
       x = "", y = expression(R^2)) +
  theme_minimal()
```

# éšæœºæ£®æ—
```{r}
# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
library(randomForest)
library(dplyr)
library(ggplot2)
library(tidyr)

# ğŸ“Œ è®¾ç½®å‚æ•°
set.seed(123)
n_repeat <- 100
n_sample <- 7
X_all <- data_remained
X_explicit <- X_all[, 1:133]
X_implicit <- X_all[, 134:140]

# ğŸ“Œ åˆå§‹åŒ–æ€»ç»“æœè¡¨
results_all_rf <- data.frame()

# ğŸ“Œ éå† health_var ä¸­çš„æ‰€æœ‰é¢„æµ‹å˜é‡ï¼ˆé™¤ç¬¬1åˆ— IDï¼‰
for (varname in colnames(health_var)[-1]) {
  
  y <- health_var[[varname]]  # å½“å‰ç›®æ ‡å˜é‡
  
  results <- data.frame(iteration = 1:n_repeat,
                        outcome = varname,
                        RMSE_exp = NA,
                        RMSE_imp = NA,
                        R2_exp = NA,
                        R2_imp = NA)
  
  for (i in 1:n_repeat) {
    # â€”â€” Step 1: æ˜¾æ€§æŠ½æ ·
    sampled_cols <- sample(colnames(X_explicit), n_sample)
    X_sampled <- X_explicit[, sampled_cols]
    
    # â€”â€” Step 2: æ˜¾æ€§éšæœºæ£®æ—å»ºæ¨¡ï¼ˆæŠ½æ ·7é¡¹ï¼‰
    rf_exp <- randomForest(x = X_sampled, y = y, ntree = 500)
    pred_exp <- predict(rf_exp, newdata = X_sampled)
    rmse_exp <- sqrt(mean((pred_exp - y)^2))
    r2_exp <- 1 - sum((pred_exp - y)^2) / sum((y - mean(y))^2)
    
    # â€”â€” Step 3: éšæ€§éšæœºæ£®æ—å»ºæ¨¡ï¼ˆ7é¡¹å…¨é‡ï¼‰
    rf_imp <- randomForest(x = X_implicit, y = y, ntree = 500)
    pred_imp <- predict(rf_imp, newdata = X_implicit)
    rmse_imp <- sqrt(mean((pred_imp - y)^2))
    r2_imp <- 1 - sum((pred_imp - y)^2) / sum((y - mean(y))^2)
    
    # â€”â€” Step 4: å­˜å‚¨ç»“æœ
    results$RMSE_exp[i] <- rmse_exp
    results$RMSE_imp[i] <- rmse_imp
    results$R2_exp[i] <- r2_exp
    results$R2_imp[i] <- r2_imp
  }
  
  # â€”â€” åˆå¹¶è¿›æ€»è¡¨
  results_all_rf <- rbind(results_all_rf, results)
}

# âœ… æ±‡æ€»å¹³å‡ç»“æœ
summary_rf <- results_all_rf %>%
  group_by(outcome) %>%
  summarise(
    mean_RMSE_exp = mean(RMSE_exp),
    mean_RMSE_imp = mean(RMSE_imp),
    mean_R2_exp = mean(R2_exp),
    mean_R2_imp = mean(R2_imp)
  )

print(summary_rf)

results_long_rf <- results_all_rf %>%
  pivot_longer(cols = c(R2_exp, R2_imp), names_to = "type", values_to = "R2")

ggplot(results_long_rf, aes(x = type, y = R2, fill = type)) +
  geom_boxplot(alpha = 0.6, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1.2, color = "black") +
  facet_wrap(~ outcome, scales = "free_x") +
  scale_y_continuous(limits = c(0.2, 1)) +
  labs(title = "éšæœºæ£®æ—é¢„æµ‹ä¸‹æ˜¾æ€§ vs éšæ€§æµ‹é‡é¢„æµ‹åŠ›",
       x = "", y = expression(R^2)) +
  theme_minimal()
```


